name: Standards Validation
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-standards:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d  # v5.1.0
        with:
          python-version: '3.11'

      - name: Validate YAML Files
        run: |
          pip install yamllint
          yamllint config/standards-schema.yaml

      - name: Validate JSON Files
        run: |
          python -m json.tool config/standards-api.json > /dev/null

      - name: Check Standards Schema Consistency
        run: python scripts/validate_standards_consistency.py

      - name: Validate Markdown Standards Links
        run: python scripts/validate_markdown_links.py

      - name: Check Standards Compliance Score
        id: compliance
        run: python scripts/calculate_compliance_score.py

      - name: Validate Standards Graph
        run: python scripts/validate_standards_graph.py

      - name: Generate Validation Report
        if: always()
        run: |
          echo "## Standards Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "### Compliance Score: ${{ steps.compliance.outputs.score }}%" >> validation-report.md
          echo "- Total Rules: ${{ steps.compliance.outputs.total }}" >> validation-report.md
          echo "- Required Rules: ${{ steps.compliance.outputs.required }}" >> validation-report.md
          echo "" >> validation-report.md
          echo "### Validation Status" >> validation-report.md
          echo "- YAML Schema: âœ…" >> validation-report.md
          echo "- JSON API: âœ…" >> validation-report.md
          echo "- Standards References: âœ…" >> validation-report.md
          echo "- Markdown Links: âœ…" >> validation-report.md

      - name: Upload Validation Report
        if: always()
        uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392  # v4.0.0
        with:
          name: validation-report
          path: validation-report.md

      - name: Comment PR with Validation Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const score = '${{ steps.compliance.outputs.score }}';
            const total = '${{ steps.compliance.outputs.total }}';
            const required = '${{ steps.compliance.outputs.required }}';

            const comment = `## ðŸ“Š Standards Validation Results

            **Compliance Score:** ${score}%

            | Metric | Value |
            |--------|-------|
            | Total Rules | ${total} |
            | Required Rules | ${required} |
            | Schema Validation | âœ… |
            | Reference Validation | âœ… |

            All standards validation checks passed! ðŸŽ‰`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
