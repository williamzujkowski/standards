name: Lint and Validate

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    - cron: "17 5 * * 1"  # UTC; POSIX cron - every Monday 05:17 UTC
  workflow_dispatch:

jobs:
  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pre-commit
        uses: actions/cache@v3
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit
        env:
          SKIP: no-commit-to-branch
        run: pre-commit run --all-files

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint '**/*.md' --ignore node_modules --ignore .github || true

  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: Run yamllint
        run: yamllint . || true

  link-check:
    name: Link Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # On PRs, force HEAD of the PR branch so updated audit code is evaluated
          ref: ${{ github.event.pull_request.head.sha || '' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run link check
        run: |
          python scripts/ensure-hub-links.py || true
          python scripts/generate-audit-reports.py
          # Check for broken links (informational here; hard gate is in audit-gates job)
          if grep -q "Broken links: 0" reports/generated/linkcheck.txt; then
            echo "✅ No broken links found"
          else
            echo "⚠️ Broken links detected"
            grep "Broken Internal Links" -A 20 reports/generated/linkcheck.txt || true
          fi

      - name: Upload link report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: reports/generated/linkcheck.txt

  structure-audit:
    name: Structure Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # On PRs, force HEAD of the PR branch so updated audit code is evaluated
          ref: ${{ github.event.pull_request.head.sha || '' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run structure audit
        run: |
          python scripts/ensure-hub-links.py || true
          python scripts/generate-audit-reports.py
          # Informational summary; hard gate is in audit-gates job
          if grep -q "Total issues found: 0" reports/generated/structure-audit.md; then
            echo "✅ No structure issues found"
          else
            echo "ℹ️ Structure issues detected (see artifacts)"
            head -30 reports/generated/structure-audit.md || true
          fi

      - name: Upload structure artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: structure-audit-artifacts
          path: |
            reports/generated/structure-audit.md
            reports/generated/structure-audit.json
            reports/generated/hub-matrix.tsv

  audit-gates:
    name: Enforce Audit Gates (links=0, hubs=0, orphans<=5)
    runs-on: ubuntu-latest
    env:
      ORPHAN_LIMIT: '5'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # On PRs, force HEAD of the PR branch so updated audit code is evaluated
          ref: ${{ github.event.pull_request.head.sha || '' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml pytest

      - name: Audit unit tests (hub)
        run: |
          pytest -q scripts/tests/test_hub_enforcement.py

      - name: Ensure hubs and generate reports
        run: |
          python scripts/ensure-hub-links.py || true
          python scripts/generate-audit-reports.py
          cat reports/generated/structure-audit.json

      - name: Enforce gates from JSON
        run: |
          python - <<'PY'
          import json, sys, pathlib, os
          p = pathlib.Path("reports/generated/structure-audit.json")
          if not p.exists():
              print("❌ Missing reports/generated/structure-audit.json"); sys.exit(1)
          data = json.loads(p.read_text())
          broken = int(data.get("broken_links", 999))
          orphans = int(data.get("orphans", 999))
          hubs = int(data.get("hub_violations", 999))
          limit = int(os.environ.get("ORPHAN_LIMIT", "5"))
          ok = True
          if broken > 0:
              print(f"❌ broken_links={broken} > 0"); ok = False
          if hubs > 0:
              print(f"❌ hub_violations={hubs} > 0"); ok = False
          if orphans > limit:
              print(f"❌ orphans={orphans} > {limit}"); ok = False
          if not ok:
              sys.exit(1)
          print(f"✅ audit gates satisfied (broken={broken}, hubs={hubs}, orphans={orphans} ≤ {limit})")
          PY

      - name: Upload audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-gates-artifacts
          path: |
            reports/generated/linkcheck.txt
            reports/generated/structure-audit.md
            reports/generated/structure-audit.json
            reports/generated/hub-matrix.tsv

  nist-quickstart:
    name: NIST Quickstart Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run NIST quickstart tests
        run: |
          cd examples/nist-templates/quickstart
          make test

      - name: Check NIST tags
        run: |
          cd examples/nist-templates/quickstart
          make nist-check

      - name: Full validation
        run: |
          cd examples/nist-templates/quickstart
          make validate || true

  standards-inventory:
    name: Standards Inventory Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Generate standards inventory
        run: |
          python scripts/generate-standards-inventory.py
          if [ -f reports/generated/standards-inventory.json ]; then
            echo "✅ Standards inventory generated"
            echo "Total standards: $(jq '.summary.total_documents' reports/generated/standards-inventory.json)"
            echo "Categories: $(jq '.summary.categories' reports/generated/standards-inventory.json)"
            echo "NIST-enabled: $(jq '.summary.nist_enabled' reports/generated/standards-inventory.json)"
          else
            echo "❌ Failed to generate standards inventory"
            exit 1
          fi

      - name: Upload inventory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: standards-inventory
          path: |
            reports/generated/standards-inventory.json
            reports/generated/standards-quick-reference.md

  product-matrix-validation:
    name: Product Matrix Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate product matrix YAML
        run: |
          if [ ! -f config/product-matrix.yaml ]; then
            echo "❌ Product matrix not found"
            exit 1
          fi
          echo "✅ Product matrix found"

      - name: Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Validate matrix structure
        run: |
          echo "Checking product matrix structure..."
          version=$(yq '.version' config/product-matrix.yaml)
          if [ "$version" = "null" ]; then
            echo "❌ Missing version field"
            exit 1
          fi
          products=$(yq '.products | keys | length' config/product-matrix.yaml)
          if [ "$products" -eq 0 ]; then
            echo "❌ No products defined"
            exit 1
          fi
          echo "✅ Product matrix structure valid"
          echo "  Version: $version"
          echo "  Products defined: $products"

  nist-compliance-check:
    name: NIST Compliance Check (Changed Files)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(py|js|ts|go|java|yaml|yml)$' | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Check NIST tags in changed files
        if: steps.changed-files.outputs.files != ''
        run: |
          changed_files="${{ steps.changed-files.outputs.files }}"
          echo "Checking NIST tags in changed files..."
          for file in $changed_files; do
            if [ -f "$file" ]; then
              if grep -qE "(auth|password|encrypt|session|permission|audit|validate)" "$file"; then
                if ! grep -q "@nist" "$file"; then
                  echo "::warning file=$file::Security code detected without NIST control tags"
                  echo "⚠️ $file: Contains security code but missing NIST tags"
                else
                  echo "✅ $file: Has NIST tags"
                fi
              fi
            fi
          done

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs:
      - pre-commit
      - markdown-lint
      - yaml-lint
      - link-check
      - structure-audit
      - audit-gates
      - nist-quickstart
      - standards-inventory
      - product-matrix-validation
      - nist-compliance-check
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## 📊 Validation Summary"
          echo ""
          echo "### Check Results:"
          echo "- Pre-commit: ${{ needs.pre-commit.result }}"
          echo "- Markdown lint: ${{ needs.markdown-lint.result }}"
          echo "- YAML lint: ${{ needs.yaml-lint.result }}"
          echo "- Link check: ${{ needs.link-check.result }}"
          echo "- Structure audit: ${{ needs.structure-audit.result }}"
          echo "- Audit gates: ${{ needs.audit-gates.result }}"
          echo "- NIST quickstart: ${{ needs.nist-quickstart.result }}"
          echo "- Standards inventory: ${{ needs.standards-inventory.result }}"
          echo "- Product matrix: ${{ needs.product-matrix-validation.result }}"
          echo "- NIST compliance (changed files): ${{ needs.nist-compliance-check.result }}"
          echo ""
          # Fail pipeline if critical gates fail
          if [ "${{ needs.audit-gates.result }}" != "success" ] || \
             [ "${{ needs.standards-inventory.result }}" = "failure" ] || \
             [ "${{ needs.product-matrix-validation.result }}" = "failure" ] || \
             [ "${{ needs.nist-quickstart.result }}" = "failure" ]; then
            echo "❌ Critical checks failed"
            exit 1
          fi
          echo "✅ All critical checks passed"
